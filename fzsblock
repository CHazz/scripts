#updater dns blacklistu

cd /home/dnsblocker
status="OK"
rm status.txt
touch status.txt

clear

echo =====================================
echo DNS Blacklist generator V0.7.3 stable
echo =====================================

echo stahování aktualizací

# blacklist UT1 zdroj 1

	rm adult.tar.gz 2> /dev/null
	sudo rm -rf adult 2> /dev/null
	wget http://dsi.ut-capitole.fr/blacklists/download/adult.tar.gz -q --show-progress

                file="adult.tar.gz"
                if [ -f "$file" ]
                        then
                                echo ""
                        else
                                echo "problém při stažení $file Beru ze zálohy !!"
                                cp  /home/dnsblocker/cache/adult.tar.gz /home/dnsblocker/
				status="CHYBA"
				echo "chyba zdroje UT1 https://dsi.ut-capitole.fr/blacklists/index_en.php" >> status.txt
				echo "použita záloha 1 (upravte URL)" >> status.txt
                        fi

		tar -xvzf adult.tar.gz > /dev/null
		cp /home/dnsblocker/adult/domains /home/dnsblocker/
		sudo rm -rf adult 2> /dev/null
		mv domains UT1	

		var=$(diff /home/dnsblocker/cache/UT1 /home/dnsblocker/UT1 | grep "^>" | wc -l)
		cmp --silent /home/dnsblocker/cache/adult.tar.gz /home/dnsblocker/adult.tar.gz || echo "zdroj 1 (adult blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/UT1 2> /dev/null
                cp  /home/dnsblocker/UT1 /home/dnsblocker/cache/

		rm  /home/dnsblocker/cache/adult.tar.gz 2> /dev/null
		cp  /home/dnsblocker/adult.tar.gz  /home/dnsblocker/cache/


# black list na black list :) zdroj 2

        rm hosts 2> /dev/null
        wget https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts -q --show-progress

                file="hosts"
                if [ -f "$file" ]
                        then
                                echo ""
                        else
                                echo "problém při stažení $file Beru ze zálohy !!"
                                cp  /home/dnsblocker/cache/bblock /home/dnsblocker/
				mv bblock hosts
                                status="CHYBA" 
				echo "chyba zdroje StevenBlack https://github.com/StevenBlack/hosts" >> status.txt
				echo "použita záloha 2 (upravte URL)" >> status.txt
                        fi

			mv hosts bblock
			var=$(diff /home/dnsblocker/cache/bblock /home/dnsblocker/bblock | grep "^>" | wc -l)
                        cmp --silent /home/dnsblocker/cache/bblock /home/dnsblocker/bblock || echo "zdroj 2 (malware blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/bblock 2> /dev/null
                cp  /home/dnsblocker/bblock  /home/dnsblocker/cache/


# porn a adds .. musi byt opraven zdroj 3

        rm hosts 2> /dev/null
        wget https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn/hosts -q --show-progress

                file="hosts"
                if [ -f "$file" ]
                        then
                                echo ""
                        else
                               echo "problém při stažení $file Beru ze zálohy !!"
                               cp  /home/dnsblocker/cache/bbad /home/dnsblocker/
                               mv bbad hosts
                               status="CHYBA"
			       echo "chyba zdroje StevenBlack https://github.com/StevenBlack/hosts/tree/master/alternates/porn" >> status.txt
			       echo "použita záloha 3 (upravte URL)" >> status.txt
                        fi

		        mv hosts bbad
			var=$(diff /home/dnsblocker/cache/bbad /home/dnsblocker/bbad | grep "^>" | wc -l)
			cmp --silent /home/dnsblocker/cache/bbad /home/dnsblocker/bbad || echo "zdroj 3 (porn blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/bbad 2> /dev/null
                cp  /home/dnsblocker/bbad  /home/dnsblocker/cache/


# ads zdroj 4
	rm ad_servers.txt 2> /dev/null
	wget https://hosts-file.net/ad_servers.txt -q --show-progress

		file="ad_servers.txt"
		if [ -f "$file" ]
			then
				echo ""
			else
                               echo "problém při stažení $file Beru ze zálohy !!"
                               cp  /home/dnsblocker/cache/ad_servers.txt /home/dnsblocker/
                               status="CHYBA"
			       echo "chyba zdroje AD (reverse) https://hosts-file.net/ad_servers.txt" >> status.txt
			       echo "použita záloha 4 (upravte URL)" >> status.txt
			fi

				var=$(diff /home/dnsblocker/cache/ad_servers.txt /home/dnsblocker/ad_servers.txt | grep "^>" | wc -l)
				cmp --silent /home/dnsblocker/cache/ad_servers.txt /home/dnsblocker/ad_servers.txt || echo "zdroj 4 (ads reverse blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/ad_servers.txt 2> /dev/null
                cp  /home/dnsblocker/ad_servers.txt  /home/dnsblocker/cache/



# porn hosts zdroj 5
	rm hosts 2> /dev/null
	wget https://raw.githubusercontent.com/EnergizedProtection/block/master/porn/formats/hosts -q --show-progress

                file="hosts"
                if [ -f "$file" ]
                        then
                                echo ""
                        else
				echo "problém při stažení $file Beru ze zálohy !!"
				cp  /home/dnsblocker/cache/hosts2 /home/dnsblocker/
				mv hosts2 hosts
                                status="CHYBA"
				echo "chyba zdroje EnergizedProtection porn https://github.com/EnergizedProtection/block" >> status.txt
			        echo "použita záloha 5 (upravte URL)" >> status.txt
                        fi

			mv hosts hosts2

				var=$(diff /home/dnsblocker/cache/hosts2 /home/dnsblocker/hosts2 | grep "^>" | wc -l)
				cmp --silent /home/dnsblocker/cache/hosts2 /home/dnsblocker/hosts2 || echo "zdroj 5 (Energized porn blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/hosts2 2> /dev/null
                cp  /home/dnsblocker/hosts2  /home/dnsblocker/cache/


# a jeste jeden ciste porn zdroj 6
	rm hosts 2> /dev/null



	wget https://raw.githubusercontent.com/EnergizedProtection/block/master/extensions/porn-lite/formats/hosts -q --show-progress

                file="hosts"
                if [ -f "$file" ]
                        then
                                echo ""
                        else
				echo "problém při stažení $file beru ze zálohy !!"
                                cp  /home/dnsblocker/cache/ext-porn-hosts /home/dnsblocker/
                                mv ext-porn-hosts hosts
                                status="CHYBA"
				echo "chyba zdroje EnergizedProtection porn extension https://github.com/EnergizedProtection/block" >> status.txt
				echo "použita záloha 6 (upravte URL)" >> status.txt
                        fi

			mv hosts ext-porn-hosts

				var=$(diff /home/dnsblocker/cache/ext-porn-hosts /home/dnsblocker/ext-porn-hosts | grep "^>" | wc -l)
				cmp --silent /home/dnsblocker/cache/ext-porn-hosts /home/dnsblocker/ext-porn-hosts || echo "zdroj 6 (Energized porn extra blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/ext-porn-hosts 2> /dev/null
                cp  /home/dnsblocker/ext-porn-hosts  /home/dnsblocker/cache/


# malware zdroj 7
	rm simple_malware.txt 2> /dev/null
	wget https://s3.amazonaws.com/lists.disconnect.me/simple_malware.txt -q --show-progress

                file="simple_malware.txt"
                if [ -f "$file" ]
                        then
                                echo ""
                        else
                               echo "problém při stažení $file Beru ze zálohy !!"
                               cp  /home/dnsblocker/cache/simple_malware.txt /home/dnsblocker/
                               status="CHYBA"
			       echo "chyba zdroje simple malware https://s3.amazonaws.com/lists.disconnect.me/simple_malware.txt" >> status.txt
			       echo "použita záloha 7 (upravte URL)" >> status.txt
                        fi

			       var=$(diff /home/dnsblocker/cache/simple_malware.txt /home/dnsblocker/simple_malware.txt | grep "^>" | wc -l)
			       cmp --silent /home/dnsblocker/cache/simple_malware.txt /home/dnsblocker/simple_malware.txt || echo "zdroj 7 (malware blacklist) aktualizován. ($var změn)" >> status.txt

                rm  /home/dnsblocker/cache/simple_malware.txt 2> /dev/null
                cp  /home/dnsblocker/simple_malware.txt  /home/dnsblocker/cache/


echo ===================
echo konverze blacklistu 
echo ===================

echo whitelistovani chybneho blacklistu

	grep -Fvxf bblock bbad > fresh

echo příprava blacklistu 

	sed -i 's/0.0.0.0//g' fresh
	sed -i '/#/d' fresh

echo odstranění komentářů simple malware

	sed -i '/#/d' simple_malware.txt
	sed -i '/Malware list by Disconnect/d' simple_malware.txt
        sed -i '/^$/d' simple_malware.txt
        sed -i -r 's/\s+//g' simple_malware.txt
	echo " " >> simple_malware.txt

echo oprava protekce [̲̅p̲̅][̲̅o̲̅][̲̅r̲̅][̲̅n̲̅][̲̅a̲̅][̲̅w̲̅][̲̅a̲̅][̲̅y̲̅] 1/2

	awk '!/]/' ext-porn-hosts > temp && mv temp bingo
	rm ext-porn-hosts 2> /dev/null
	mv bingo ext-porn-hosts

echo odstranění komentů porn hosts2
        sed -i '/#/d' hosts2
echo  odstranění chybných záznamů porn hosts2
        sed -i '/127.0.0.1 localhost/d' hosts2
echo -en 7.1% "\r$i"
        sed -i '/127.0.0.1 localhost.localdomain/d' hosts2
echo -en 14.2% "\r$i"
        sed -i '/127.0.0.1 local/d' hosts2
echo -en 21.4% "\r$i"
        sed -i '/255.255.255.255 broadcasthost/d' hosts2
echo -en 28.5% "\r$i"
        sed -i '/::1 localhost/d' hosts2
echo -en 35.7% "\r$i"
        sed -i '/::1 ip6-localhost/d' hosts2
echo -en 42.8% "\r$i"
        sed -i '/::1 ip6-loopback/d' hosts2
echo -en 50.0% "\r$i"
        sed -i '/fe80::1%lo0 localhost/d' hosts2
echo -en 57.1% "\r$i"
        sed -i '/ff00::0 ip6-localnet/d' hosts2
echo -en 64.2% "\r$i"
        sed -i '/ff00::0 ip6-mcastprefix/d' hosts2
echo -en 71.4% "\r$i"
        sed -i '/ff02::1 ip6-allnodes/d' hosts2
echo -en 78.5% "\r$i"
        sed -i '/ff02::2 ip6-allrouters/d' hosts2
echo -en 85.7% "\r$i"
        sed -i '/ff02::3 ip6-allhosts/d' hosts2
echo -en 92.8% "\r$i"
        sed -i '/0.0.0.0 0.0.0.0/d' hosts2
echo 100%.


echo odstanění prázdných záznamů porn host2s

        sed -i '/^$/d' hosts2
        sed -i -r 's/\s+//g' hosts2

echo úprava záznamů porn hosts2

        sed -i 's/0.0.0.0//g' hosts2


echo oprava protekce 2/2


 awk '!/]/' hosts2 > temp && mv temp bingo
        rm hosts2 2> /dev/null
        mv bingo hosts

echo odstranění komentů ext-porn
        sed -i '/#/d' ext-porn-hosts
echo  odstranění chybných záznamů ext-porn
        sed -i '/127.0.0.1 localhost/d' ext-porn-hosts
echo -en 7.1% "\r$i"
        sed -i '/127.0.0.1 localhost.localdomain/d' ext-porn-hosts
echo -en 14.2% "\r$i"
        sed -i '/127.0.0.1 local/d' ext-porn-hosts
echo -en 21.4% "\r$i"
        sed -i '/255.255.255.255 broadcasthost/d' ext-porn-hosts
echo -en 28.5% "\r$i"
        sed -i '/::1 localhost/d' ext-porn-hosts
echo -en 35.7% "\r$i"
        sed -i '/::1 ip6-localhost/d' ext-porn-hosts
echo -en 42.8% "\r$i"
        sed -i '/::1 ip6-loopback/d' ext-porn-hosts
echo -en 50.0% "\r$i"
        sed -i '/fe80::1%lo0 localhost/d' ext-porn-hosts
echo -en 57.1% "\r$i"
        sed -i '/ff00::0 ip6-localnet/d' ext-porn-hosts
echo -en 64.2% "\r$i"
        sed -i '/ff00::0 ip6-mcastprefix/d' ext-porn-hosts
echo -en 71.4% "\r$i"
        sed -i '/ff02::1 ip6-allnodes/d' ext-porn-hosts
echo -en 78.5% "\r$i"
        sed -i '/ff02::2 ip6-allrouters/d' ext-porn-hosts
echo -en 85.7% "\r$i"
        sed -i '/ff02::3 ip6-allhosts/d' ext-porn-hosts
echo -en 92.8% "\r$i"
        sed -i '/0.0.0.0 0.0.0.0/d' ext-porn-hosts
echo 100%.


echo odstanění prázdných záznamů ext-porn

        sed -i '/^$/d' ext-porn-hosts
        sed -i -r 's/\s+//g' ext-porn-hosts

echo úprava záznamů ext-porn

        sed -i 's/0.0.0.0//g' ext-porn-hosts


echo Propojení blacklistů 

        sed -i -r 's/\s+//g' perBlacklist
        sed -i '/^$/d' perBlacklist

	rm domainsC 2> /dev/null
	cat ext-porn-hosts hosts simple_malware.txt fresh UT1 > domainsC


echo odstraneni blogspot zaznamu 

	sed -i '/blogspot./d' domainsC

echo odstraneni tumblr.com

	sed -i '/tumblr.com/d' domainsC

cat domainsC perBlacklist > domains

echo odstranění nepoužitelných IP

	grep -P -v '^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}$' domains > domains.list

echo odstranění komentů ADS

        sed -i '/#/d' ad_servers.txt
	sed -i '/127.0.0.1 localhost #IPv4 localhost/d' ad_servers.txt
	sed -i '/::1 localhost #IPv6 localhost/d' ad_servers.txt

echo úprava záznamů ADS

        sed -i 's/127.0.0.1//g' ad_servers.txt
        sed -i '/^$/d' ad_servers.txt
        sed -i -r 's/\s+//g' ad_servers.txt

echo příprava porovávacího souboru ADS

        sed -i '/^$/d' ad_servers.txt
        sed -i -r 's/\s+//g' ad_servers.txt

        sed -i 's/^/"/' ad_servers.txt
        sed -i 's/$/",/' ad_servers.txt
        sed -i '/^$/d' ad_servers.txt

echo úprava záznamů pro primarni BL 1/2

        sed -i 's/$/",/' domains.list

echo úprava záznamů pro primarni BL 2/2

        sed -i 's/^/"/' domains.list


echo reversni aplikace ADS

       rm domains.list2 2> /dev/null
       grep -Fvxf ad_servers.txt domains.list > domains.list2


echo aktualizace black/white listu z github

	cd github
	git pull
	cd ..

echo generování výstupu blacklistu

	rm blacklist 2> /dev/null
	cp /home/dnsblocker/github/blacklist /home/dnsblocker/

	sed -i '/^$/d' blacklist
        sed -i -r 's/\s+//g' blacklist

	sed -i 's/^/"/' blacklist
	sed -i 's/$/",/' blacklist
	sed -i '/^$/d' blacklist

echo připojení blacklistu z github
	
	rm blacklisted 2> /dev/null
	cat domains.list2 blacklist > blacklisted
	dos2unix blacklisted

echo generování výstupu whitelistu z github

	rm whitelist 2> /dev/null
        cp /home/dnsblocker/github/whitelist /home/dnsblocker/

	cat perWhitelist whitelist > whitelistB
	rm whitelist 2> /dev/null
	mv whitelistB whitelist


	#subdomeny
	rm whitelistD 2> /dev/null
        sed 's/^/./' whitelist > whitelistD

	sed -i '/^$/d' whitelist
	sed -i -r 's/\s+//g' whitelist

	sed -i 's/^/"/' whitelist
	sed -i 's/$/",/' whitelist
	sed -i '/^$/d' whitelist

echo připojení whitelistu

	dos2unix blacklisted -q
	dos2unix whitelistD -q
	dos2unix whitelist -q

	rm blocklistA 2> /dev/null

	grep -vFf whitelistD blacklisted > blacklistD
	grep -Fvxf whitelist blacklistD > blocklist

echo odstanění prázdných záznamů 

        sed -i '/^$/d' blocklist
	sed -i -r 's/\s+//g' blocklist

echo oprava nepoužitelných záznamů

	sed -i 's|/"|"|g' blocklist

echo kontrola duplicitních záznamů

        awk '!x[$0]++' blocklist > blocklist.lua

echo seřazení podle abecedy

	sort blocklist.lua -o blocklist.lua

echo kontrola domén

	sed -i '/\./!d' blocklist.lua

echo přidání tagů

        sed -i '1i return{' blocklist.lua
	echo "}" >> blocklist.lua

echo čištění a oprava kompatiblity

	rm adult.tar.gz 2> /dev/null
	rm UT1 2> /dev/null
        rm ad_servers.txt 2> /dev/null
        rm blacklist 2> /dev/null
        rm blacklistD 2> /dev/null
        rm blacklisted 2> /dev/null
        rm blocklist 2> /dev/null
        rm blocklistA 2> /dev/null
        rm domains.list 2> /dev/null
	rm domains.list2 2> /dev/null
        rm ext-porn-hosts 2> /dev/null
        rm domains 2> /dev/null
	rm domainsC 2> /dev/null
        rm hosts 2> /dev/null
	rm bbad 2> /dev/null
	rm bblock 2> /dev/null
	rm fresh 2> /dev/null
        rm simple_malware.txt 2> /dev/null
	rm whitelist 2> /dev/null
	rm whitelistD 2> /dev/null
	dos2unix blocklist.lua

echo příprava pro zveřejnění
	 
	rm /var/www/html/blocklist.lua 2> /dev/null
	cp /home/dnsblocker/blocklist.lua /var/www/html

	rm /home/dnsblocker/cache/whitelist 2> /dev/null
	cp /home/dnsblocker/github/whitelist /home/dnsblocker/cache     

	rm /home/dnsblocker/cache/blacklist 2> /dev/null
        cp /home/dnsblocker/github/blacklist /home/dnsblocker/cache

	pocet=$(sed -n '$=' blocklist.lua)
	size=$(wc -c < "blocklist.lua")
	echo "Počet záznamů :" $pocet >> status.txt
	echo "Velikost blacklistu :" $size"b" >> status.txt

		var=$(diff /home/dnsblocker/cache/blocklist.lua /home/dnsblocker/blocklist.lua | grep "^>" | wc -l)
                cmp --silent /home/dnsblocker/cache/blocklist.lua /home/dnsblocker/blocklist.lua || echo "Celkem aplikovaných změn v databázi : $var" >> status.txt

		mv -f /home/dnsblocker/status.txt /home/dnsblocker/github

		rm /home/dnsblocker/cache/blocklist.lua 2> /dev/null
		cp /home/dnsblocker/blocklist.lua /home/dnsblocker/cache/blocklist.lua

echo zveřejnění změn na github

	cd  github

	git add .
	git commit -m "Auto Update : `date` '$status'" -m "počet záznamů : '$pocet' velikost : '$size'"
     #git commit --amend --no-edit --allow-empty
     #git push --force
	git push


echo aplikace blocklistu na DNS server

	cd ..

	rm /etc/powerdns/blocklist.lua 2> /dev/null
	mv /home/dnsblocker/blocklist.lua /etc/powerdns
#	/etc/init.d/pdns-recursor stop
        echo 3 > /proc/sys/vm/drop_caches
#	/etc/init.d/pdns-recursor start

	rec_control --timeout=90 reload-lua-script


cd /

# dns2 sync

 sshpass -p updater4321 ssh -o StrictHostKeyChecking=no updater@192.168.1.3 "sudo updater2"


echo Hotovo
